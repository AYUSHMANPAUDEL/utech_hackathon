<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Tourism Navigation</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
    <style>
        /* Fullscreen Map */
        #map {
            height: 90vh;
            width: 100%;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        /* Popup Styling */
        #popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        #popup button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #popup button#yes {
            background-color: #28a745;
            color: white;
        }

        #popup button#no {
            background-color: #dc3545;
            color: white;
        }

        /* Dim Background Overlay */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="overlay"></div>
    <div id="popup">
        <p id="popup-text"></p>
        <button id="yes">Yes</button>
        <button id="no">No</button>
    </div>
    <script>
        const schedule = {{ schedule|safe }}; // Schedule with destinations
        console.log(schedule)
        let currentLat, currentLng;
        let currentIndex = 0;
        let routingControl = null;
        let userMarker = null;

        // Custom user icon
        const userIcon = L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61205.png", // GPS/marker icon
            iconSize: [35, 35],
            iconAnchor: [17, 35], // Bottom center
            popupAnchor: [0, -30],
        });

        // Initialize map with custom tile layer
        const map = L.map("map", { zoomControl: true }).setView([27.7045, 85.3076], 16); // Pathao-like zoom level
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);

        // Function to show modal popup
        const showPopup = (text, yesCallback, noCallback) => {
            const popup = document.getElementById("popup");
            const overlay = document.getElementById("overlay");
            document.getElementById("popup-text").textContent = text;

            popup.style.display = "block";
            overlay.style.display = "block";

            document.getElementById("yes").onclick = () => {
                popup.style.display = "none";
                overlay.style.display = "none";
                yesCallback();
            };
            document.getElementById("no").onclick = () => {
                popup.style.display = "none";
                overlay.style.display = "none";
                noCallback();
            };
        };

        // Get user's current location
        navigator.geolocation.getCurrentPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;

                // Show user's current location with a custom marker
                userMarker = L.marker([currentLat, currentLng], {
                    icon: userIcon,
                    draggable: true, // Allow dragging for testing
                }).addTo(map);
                userMarker.bindPopup("<b>You are here!</b>").openPopup();

                map.setView([currentLat, currentLng], 16);
                startTrip();
            },
            (error) => {
                alert("Unable to retrieve your location. Using default location.");
                currentLat = 27.7045;
                currentLng = 85.3076;
                startTrip();
            }
        );

        let isFirstSchedule = true;

        const startTrip = () => {
            const { latitude, longitude, name } = schedule[currentIndex];
            const distance = calculateDistance(currentLat, currentLng, latitude, longitude);
        
            if (distance < 0.1) { // 100 meters tolerance
                if (isFirstSchedule) {
                    navigateTo([currentLat, currentLng], [latitude, longitude]); // Skip the popup for the first destination
                    isFirstSchedule = false;
                } else {
                    showPopup(`Do you want to go to ${name}?`, () => {
                        navigateTo([currentLat, currentLng], [latitude, longitude]);
                    }, () => {
                        alert("Trip canceled.");
                    });
                }
            } else {
                setTimeout(() => {
                    startTrip(); // Keep checking until user reaches the location
                }, 3000); // Check every 3 seconds
            }
        };
        
        // Calculate distance between two coordinates (in km)
        const calculateDistance = (lat1, lng1, lat2, lng2) => {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLng = (lng2 - lng1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        };

        // Navigate to destination
        const navigateTo = (start, end) => {
            if (routingControl) {
                map.removeControl(routingControl);
            }
            routingControl = L.Routing.control({
                waypoints: [L.latLng(start[0], start[1]), L.latLng(end[0], end[1])],
                routeWhileDragging: true,
            }).addTo(map);

            // Update user location
            currentLat = end[0];
            currentLng = end[1];
            currentIndex++;

            if (currentIndex < schedule.length) {
                setTimeout(() => {
                    startTrip();
                }, 3000); // Simulate 3 seconds delay
            } else {
                alert("Trip complete!");
            }
        };

        // Track user's location continuously
        navigator.geolocation.watchPosition(
            (position) => {
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;

                // Update the user marker position on the map
                if (!userMarker) {
                    // Create marker if it doesn't exist
                    userMarker = L.marker([currentLat, currentLng], {
                        icon: userIcon,
                    }).addTo(map);
                } else {
                    // Update marker position
                    userMarker.setLatLng([currentLat, currentLng]);
                }

                // Center map on user's location
                map.setView([currentLat, currentLng], 16);
            },
            (error) => {
                console.error("Error watching position:", error);
            },
            {
                enableHighAccuracy: true, // Use GPS for better accuracy
                maximumAge: 0,
            }
        );
    </script>
</body>
</html>
